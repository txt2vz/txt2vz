<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='icon' href='favicon.ico' type='image/x-icon'/>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/t2v.css" >

</head>
<title>boa</title>

<body>
<div class="container  col-md-12">

    <button type="button" class="btn btn-info" data-toggle="collapse"
            data-target="#control2">Show/Hide controls/selections
    </button>
    <div id="control2" class="collapse in well">

        <div class="row">

            <div class="col-md-3">

                <br> Network Type: <select id="networkType">
                <option value="radial">Radial</option>

                <option value="partition">Partition</option>
                <option value="forceNetwork">Graph</option>
            </select> <br/> <br/>

                <div id="hint">
                    Mouse wheel to zoom. <br/> Hold click and move mouse to move
                    tree
                </div>
            </div>
            <div>
                <p> Select a valid text file:</p>

                <input type="file" id="real-file" hidden="hidden" style="display:none;" onclick="this.value=null;"/>
                <button type="button" id="custom-button">CHOOSE A FILE</button>
                <span id="custom-text">No file chosen, yet.</span>

            </div>
        </div>
    </div>
    <div class="row col-md-12">
        <div class="main"></div>
        <div id="vis"></div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="js/drawForceTree.js"></script>
<script src="js/drawDendrogram.js"></script>
<script src="js/drawForceNetwork.js"></script>
<script src="js/drawRadial.js"></script>
<script src="js/colorbrewer.js"></script>
<script src="js/frontPage.js"></script>
<script src="js/frontPage2.js"></script>
<script src="js/artai.js"></script>
<script src="js/partitionD.js"></script>

<script src="js/d3.chart.min.js"></script>
<script src="js/d3.chart.layout.hierarchy.js"></script>
<script src="https://d3js.org/d3-hierarchy.v1.min.js"></script>


<script>
    frontPage();

    function recentreNode(nodeLabel) {

        console.log("in recentre node nodeLabel is " + nodeLabel + ' filename is ' + fileName);
        textToJSON(fileText, nodeLabel);
    }

    var realFileBtn = document.getElementById("real-file");
    var customBtn = document.getElementById("custom-button");
    var fileNameElement = document.getElementById("custom-text");
    var fileName = '';

    customBtn.addEventListener("click", function () {
        realFileBtn.click();
    });


    realFileBtn.addEventListener("change", function () {

        if (realFileBtn.value) {
            fileNameElement.innerHTML = realFileBtn.value.match(
                /[\/\\]([\w\d\s\.\-\(\)]+)$/
            )[1];
            fileName = fileNameElement.innerHTML;
            console.log("filenametxt " + fileNameElement + "fileName: " + fileName);
            reload(realFileBtn.value)
        } else {
            fileNameElement.innerHTML = "No file chosen.";
        }
    });


    var fileInput = $('#real-file');
    var fileText = '';
    var dynamic_recentre = true;


    function reload(upload) {

        var input;
        console.log("in reload upload " + upload);
        if (!window.FileReader) {
            alert('Your browser is not supported')
        }
        input = fileInput.get(0);

        // Create a reader object
        var reader = new FileReader();
        if (input.files.length) {
            var textFile = input.files[0];
            reader.readAsText(textFile);

            reader.onload = function (e) {
                fileText = reader.result;
                textToJSON(fileText, '~');
            }
        }
    }


    function textToJSON(text, boostWord) {

        console.log("in texttojson net.val " + $("#networkType").val());
        //  openModal();
        jQuery.ajax({
            type: "POST",
            url: "texttojsonservice",
            cache: false,
            data: {
                text: text,
                boostWord: boostWord,
                networkType: $("#networkType").val(),
                fileName: fileName
                //    cooc : cooc,
                //    maxLinks : maxLinks,
                //  maxWords : maxWords
            },
            success: function (jsonData, textStatus, jqXHR) {
                draw(jsonData);
            },
        });
    };


    function radial(json) {
        console.log("jsonText in radial " + json);
        var ar = new Array();

        var promise0 = new Promise(function (resolve, reject) {

            d3.hierarchy(json, function (d) {
                ar.push(d.cooc);
                return d.children;
            });

            resolve(d3.extent(ar));

        });

        promise0.then(function (value) {

            var linearScale = d3.scale.linear()
                .domain(value)
                .range([2, 6]);

            d3.select("svg").remove();
            var tree = d3.select("#vis").append("svg")

                .chart("tree.radial")

                //.diameter(500)
                .radius(//4)
                    function (d) {
                        var nodeSize = linearScale(d.cooc);
                        return nodeSize;
                    })

                .levelGap(100).zoomable([0.1, 3]).collapsible(7);
            //.duration(200)
            //.sortable("_ASC_")

            tree.draw(json);
        });
    }

    function drawPartition(json) {

        d3.select("svg").remove();

        var partition = d3.select("#vis").append("svg")

            .chart("partition.rectangle")
            .value("cooc")
            .zoomable([0.5, 5])
            .collapsible()
            //.duration(200)
            .sortable("_DESC_");

        partition.draw(json);
    }

    function draw(jsonData) {

        var j = JSON.parse(jsonData);
        var visType = $("#networkType").val();

        switch (visType) {
            case 'forceTree':
                drawForceTree(j);
                break;

            case 'radial':
                radial(j);
                break;

            case 'forceNetwork':
                drawForceNetwork(j);
                break;

            case 'partition':
                drawPartition(j)
                break;

            case 'dendro':
                drawDendrogram(j)
                break;
        }
    }

    $(document).ready(function () {
        $("#hint").show();

        $("select#networkType")
            .on('change', function () {
                reload(realFileBtn.value)

                if (($("#networkType").val() == "forceTree")) {
                    $("#hint").hide();
                } else {
                    $("#hint").show();
                }
            });
    });

</script>

</body>
</html>